#!/usr/bin/env python3
"""
Telegram Bot for Uzbek Food Map
Compatible with python-telegram-bot 21.0
"""

import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, ContextTypes, CallbackQueryHandler

# ========== CONFIGURATION ==========
# Get token from environment variable
TOKEN = os.getenv("BOT_TOKEN", "8072469050:AAEci8K1Fiv7G0jLWd2Jx_vBCabCSyMn640")

# UPDATE THIS URL to your actual GitHub URL
MINI_APP_URL = "https://cat-k235.github.io/tashkent-food-telegram-app/"

# Enable logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Send a message when the command /start is issued."""
    user = update.effective_user

    # Create keyboard with Mini App button
    keyboard = [
        [InlineKeyboardButton("üó∫Ô∏è OPEN FOOD MAP", web_app={"url": MINI_APP_URL})],
        [InlineKeyboardButton("üìç Find Near Me", callback_data="location")],
        [InlineKeyboardButton("üìû Contact Support", url="https://t.me/yourusername")]
    ]

    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        f"üçΩÔ∏è *Assalomu alaykum, {user.first_name}!*\n\n"
        "*O'zbekiston Oziq-ovqat Xaritasi* ga xush kelibsiz!\n\n"
        "‚úÖ *Qanday foydalanish:*\n"
        "1. Quyidagi tugmani bosing\n"
        "2. Xaritadan ovqatlanish joylarini toping\n"
        "3. Telefon raqamlarini ko'ring\n"
        "4. To'g'ridan-to'g'ri qo'ng'iroq qiling\n\n"
        "üìç *Toshkent shahridagi barcha restoranlar, kafelar va tez ovqat joylari*",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Send a message when the command /help is issued."""
    await update.message.reply_text(
        "üÜò *Yordam:*\n\n"
        "*/start* - Botni ishga tushirish\n"
        "*/help* - Yordam olish\n"
        "*/map* - Xaritani ochish\n\n"
        "üìç *Muammo bo'lsa:*\n"
        "1. Internet aloqangizni tekshiring\n"
        "2. Botni qayta ishga tushiring: /start\n"
        "3. @yourusername ga murojaat qiling",
        parse_mode='Markdown'
    )


async def map_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle /map command - directly opens Mini App."""
    keyboard = [[InlineKeyboardButton("üó∫Ô∏è Hozir ochish", web_app={"url": MINI_APP_URL})]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await update.message.reply_text(
        "Toshkent oziq-ovqat xaritasi ochilmoqda...",
        reply_markup=reply_markup
    )


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle button callbacks."""
    query = update.callback_query
    await query.answer()

    if query.data == "location":
        await query.message.reply_text(
            "üìç *Joylashuvingizni topish:*\n\n"
            "1. Xaritani oching (pastdagi tugma)\n"
            "2. üìç belgisini bosing\n"
            "3. Joylashuvga ruxsat bering\n"
            "4. Xarita sizning joylashuvingizga yaqinlashadi\n\n"
            "Eng yaqin ovqatlanish joylarini toping!",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üó∫Ô∏è Xaritani ochish", web_app={"url": MINI_APP_URL})]
            ]),
            parse_mode='Markdown'
        )


def main():
    """Start the bot."""
    # Create Application
    application = Application.builder().token(TOKEN).build()

    # Add command handlers
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("map", map_command))

    # Add callback query handler
    application.add_handler(CallbackQueryHandler(button_handler))

    # Start the bot
    logger.info("ü§ñ Bot ishga tushmoqda... @uzbekfoodmapbot")
    logger.info(f"‚úÖ Token: {TOKEN[:10]}...")  # Show only first 10 chars for security
    application.run_polling()


if __name__ == '__main__':
    main()
