<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tashkent Food Map (Optimized)</title>

<!-- Leaflet & MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
  * {margin: 0; padding: 0; box-sizing: border-box;}
  body {font-family: system-ui, sans-serif;}
  #map {height: 100vh; width: 100vw;}
  .stats {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      z-index: 1000;
  }
  .popup-content {min-width: 220px;}
  .popup-title {font-weight: bold; font-size: 16px; margin-bottom: 4px;}
  .popup-info {font-size: 14px; color: #333;}
</style>
</head>
<body>

<div id="map"></div>
<div id="stats" class="stats">Loading real food places...</div>

<!-- Leaflet & MarkerCluster JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
const map = L.map('map').setView([41.2995, 69.2401], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

const stats = document.getElementById('stats');
const markerCluster = L.markerClusterGroup();
let cachedPlaces = null;

function updateStats(text) {
  stats.textContent = text;
}

// Fetch and display real OSM food places
async function fetchRealTashkentPlaces() {
  updateStats("üîÑ Loading real food places from OpenStreetMap...");
  const bbox = "41.25,69.15,41.37,69.35"; // Tashkent central area

  const query = `
  [out:json][timeout:25];
  (
    node["amenity"~"restaurant|cafe|fast_food|bar|food_court"](${bbox});
  );
  out body;
  `;

  try {
    const response = await fetch("https://overpass.kumi.systems/api/interpreter", {
      method: "POST",
      headers: {"Content-Type": "application/x-www-form-urlencoded"},
      body: "data=" + encodeURIComponent(query)
    });

    if (!response.ok) throw new Error("Overpass API error " + response.status);
    const data = await response.json();

    const places = data.elements
      .filter(e => e.type === "node" && e.lat && e.lon)
      .map(e => ({
        id: e.id,
        name: e.tags?.name || "Unnamed place",
        category:
          e.tags?.amenity === "fast_food" ? "fastfood" :
          e.tags?.amenity === "cafe" ? "cafe" :
          "restaurant",
        lat: e.lat,
        lng: e.lon,
        phone: e.tags?.phone || e.tags?.["contact:phone"] || e.tags?.["contact:mobile"] || "Not provided",
        address: e.tags?.["addr:street"] ? `${e.tags["addr:street"]}, Tashkent` : "Tashkent",
        hours: e.tags?.opening_hours || "Not specified",
        cuisine: e.tags?.cuisine || "General"
      }));

    console.log("Fetched:", places.length, "places");
    updateStats(`‚úÖ Loaded ${places.length} real food places`);
    localStorage.setItem("tashkentFoodData", JSON.stringify(places));
    return places;
  } catch (err) {
    console.error("Error fetching OSM data:", err);
    updateStats("‚ö†Ô∏è Loading cached data...");
    const cache = localStorage.getItem("tashkentFoodData");
    return cache ? JSON.parse(cache) : [];
  }
}

// Add markers with clustering
function addMarkersToMap(places) {
  markerCluster.clearLayers();

  places.forEach(p => {
    const color =
      p.category === "fastfood" ? "#FF4757" :
      p.category === "cafe" ? "#FFA502" :
      "#2ED573";

    const icon = L.divIcon({
      html: `<div style="
        background:${color};
        width:28px;height:28px;
        border-radius:50%;
        border:2px solid white;
        display:flex;align-items:center;justify-content:center;
        color:white;font-size:14px;">üç¥</div>`,
      className: "custom-icon",
      iconSize: [28, 28],
      iconAnchor: [14, 28],
      popupAnchor: [0, -28]
    });

    const popup = `
      <div class="popup-content">
        <div class="popup-title">${p.name}</div>
        <div class="popup-info">üìç ${p.address}</div>
        <div class="popup-info">üìû ${p.phone}</div>
        <div class="popup-info">üïí ${p.hours}</div>
        <div class="popup-info">üçΩÔ∏è ${p.cuisine}</div>
      </div>
    `;

    const marker = L.marker([p.lat, p.lng], {icon}).bindPopup(popup);
    markerCluster.addLayer(marker);
  });

  map.addLayer(markerCluster);
  updateStats(`üìç ${places.length} places shown`);
}

// Initialize app
(async function init() {
  const cached = localStorage.getItem("tashkentFoodData");
  if (cached) {
    console.log("Using cached data");
    addMarkersToMap(JSON.parse(cached));
    updateStats("‚ö° Showing cached data...");
  }

  const places = await fetchRealTashkentPlaces();
  if (places.length > 0) addMarkersToMap(places);
  else updateStats("‚ùå No places found.");
})();
</script>

</body>
</html>

